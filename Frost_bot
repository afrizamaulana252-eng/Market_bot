from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes
import requests
import schedule
import threading
import time
import os

# ===== CONFIG =====
TOKEN = os.environ.get("BOT_TOKEN")
CRYPTO_NEWS_API_KEY = os.environ.get("NEWS_API_KEY")
YOUR_CHAT_ID = os.environ.get("CHAT_ID")
watchlist = {}

# ===== COMMANDS =====
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "Halo! Bot Crypto siap ðŸš€\n\nCommands:\n/crypto BTC\n/crypto ETH\n/crypto SOL\n/news\n/add_watchlist BTC 30000\n/show_watchlist"
    )

async def crypto_price(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if len(context.args) == 0:
        await update.message.reply_text("Gunakan: /crypto BTC")
        return
    coin = context.args[0].lower()
    try:
        data = requests.get(f"https://api.coingecko.com/api/v3/simple/price?ids={coin}&vs_currencies=usd").json()
        price = data[coin]["usd"]
        await update.message.reply_text(f"{coin.upper()} Price: ${price}")
    except:
        await update.message.reply_text("Koin tidak ditemukan!")

async def news(update: Update, context: ContextTypes.DEFAULT_TYPE):
    url = f"https://cryptopanic.com/api/v1/posts/?auth_token={CRYPTO_NEWS_API_KEY}&public=true"
    data = requests.get(url).json()
    messages = [f"{item['title']} - {item['url']}" for item in data['results'][:5]]
    await update.message.reply_text("\n\n".join(messages))

async def add_watchlist(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        coin = context.args[0].upper()
        price = float(context.args[1])
        watchlist[coin] = price
        await update.message.reply_text(f"{coin} ditambahkan ke watchlist dengan target ${price}")
    except:
        await update.message.reply_text("Format salah. Contoh: /add_watchlist BTC 30000")

async def show_watchlist(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if watchlist:
        msg = "\n".join([f"{c}: target ${p}" for c, p in watchlist.items()])
    else:
        msg = "Watchlist kosong"
    await update.message.reply_text(msg)

# ===== ALERT NOTIF =====
def check_prices(app):
    for coin, target in watchlist.items():
        coin_id = coin.lower()
        try:
            data = requests.get(f"https://api.coingecko.com/api/v3/simple/price?ids={coin_id}&vs_currencies=usd").json()
            current = data[coin_id]["usd"]
            if current >= target:
                app.bot.send_message(chat_id=YOUR_CHAT_ID, text=f"âš¡ {coin} sudah mencapai ${current} (target: ${target})")
        except:
            pass

def run_schedule(app):
    schedule.every(1).minutes.do(lambda: check_prices(app))
    while True:
        schedule.run_pending()
        time.sleep(1)

# ===== MAIN =====
app = ApplicationBuilder().token(TOKEN).build()
app.add_handler(CommandHandler("start", start))
app.add_handler(CommandHandler("crypto", crypto_price))
app.add_handler(CommandHandler("news", news))
app.add_handler(CommandHandler("add_watchlist", add_watchlist))
app.add_handler(CommandHandler("show_watchlist", show_watchlist))

threading.Thread(target=run_schedule, args=(app,), daemon=True).start()
app.run_polling()
